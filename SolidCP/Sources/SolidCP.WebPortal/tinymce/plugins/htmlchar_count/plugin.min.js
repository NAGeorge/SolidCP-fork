tinymce.PluginManager.add('htmlchar_count', function (editor) {
    var self = this;

    function update() {
        editor.theme.panel.find('#htmlchar_count').text(['HTML Characters: {0}', editor.getContent().length + ' / ' + editor.settings.max_chars]);
    }

    editor.on('init', function () {
        var statusbar = editor.theme.panel && editor.theme.panel.find('#statusbar')[0];

        if (statusbar) {
            window.setTimeout(function () {
                statusbar.insert({
                    type: 'label',
                    name: 'htmlchar_count',
                    text: ['HTML Characters: {0}', editor.getContent().length + ' / ' + editor.settings.max_chars],
                    classes: 'wordcount',
                    disabled: editor.settings.readonly
                }, 0);

                editor.on('setcontent beforeaddundo', update);

                editor.on('keyup', function (e) {
                    update();
                });
                var allowedKeys = [8, 37, 38, 39, 40, 46]; // backspace, delete and cursor keys
                editor.on('keydown', function (e) {
                    if (allowedKeys.indexOf(e.keyCode) != -1) return true;
                    if ((tinymce.get(tinymce.activeEditor.id).getContent().length + 1) > editor.settings.max_chars) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                    return true;
                });
            }, 0);
        }
    });
});